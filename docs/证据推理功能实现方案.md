# 证据推理功能实现方案

## 一、当前实现状态

### 已实现

| 功能 | 状态 | 说明 |
|------|------|------|
| 证据等级标注 | ✅ 已完成 | 实体/关系携带 `evidence_level` 属性 |
| 证据链类型 | ✅ 已完成 | 关系边携带 `relation_type` 属性 |
| 溯源信息 | ✅ 已完成 | 携带 `source_provenance` |
| 场景标签 | ✅ 已完成 | 携带 `scene_tags` |
| 多维查询 | ✅ 已完成 | 按等级/类型/场景查询 |
| 向量入库增强 | ✅ 已完成 | 向量数据库包含证据链字段 |
| **因果链追溯** | ✅ 已完成 | `get_causal_chain()` |
| **证据聚合** | ✅ 已完成 | `aggregate_evidence()` |
| **交叉验证** | ✅ 已完成 | `cross_validate()` |

---

## 二、功能说明

### 2.1 因果链追溯 `get_causal_chain()`

从某实体出发，追溯完整的 causal 类型因果链路径。

**参数：**
- `entity_id`: 起始实体ID
- `max_depth`: 最大追溯深度（默认5）
- `evidence_level`: 证据等级过滤（可选）
- `limit`: 返回结果数量限制

**返回：** 因果链路径列表，包含路径上的实体、关系和长度

### 2.2 证据聚合 `aggregate_evidence()`

聚合相同主题/类型/场景的证据，计算综合权重。

**参数：**
- `topic`: 主题关键词
- `scene_tag`: 场景标签
- `evidence_level`: 证据等级
- `min_weight`: 最小权重阈值
- `limit`: 返回结果数量限制

**返回：** 聚合后的证据列表

### 2.3 交叉验证 `cross_validate()`

检测 support/contradict 关系，验证证据一致性。

**参数：**
- `claim_entity`: 待验证的观点/claim实体
- `min_evidence_count`: 最少证据数量

**返回：** 验证结果，包含支持/反驳证据和结论

### 2.4 证据链基础查询接口

提供更细粒度的证据检索能力。

- `get_entities_by_evidence_level(level, limit)`: 获取指定可信度等级的实体节点
- `get_relations_by_type(type, limit)`: 获取指定逻辑类型（causal/support等）的关系边
- `get_entity_provenance(name)`: 获取实体的多级溯源详情
- `get_entities_by_scene(tag, limit)`: 按场景标签（如“风险控制”）筛选知识
- `get_entities_by_file(path, limit)`: 追溯特定原始文件关联的所有知识点

---

## 三、验证结论规则

| 条件 | 结论 |
|------|------|
| support > contradict × 1.5 | 证据支持 |
| contradict > support × 1.5 | 证据反驳 |
| support > 0 且 contradict > 0 | 证据存在分歧 |
| 仅支持证据 | 证据支持(单方面) |
| 仅反驳证据 | 证据反驳(单方面) |
| 都为0 | 证据不足 |

## 四、证据等级权重

| 等级 | 权重 |
|------|------|
| S | 4 |
| A | 3 |
| B | 2 |
| C | 1 |

---

## 五、使用示例

```python
# 1. 因果链追溯
results = await kg.get_causal_chain(
    entity_id="降准政策",
    max_depth=5,
    evidence_level="S"
)

# 2. 证据聚合
results = await kg.aggregate_evidence(
    topic="科创板",
    scene_tag="投研分析"
)

# 3. 交叉验证
result = await kg.cross_validate(
    claim_entity="货币政策将利好股市"
)
print(f"结论: {result['conclusion']}")
```

---

## 六、入库字段汇总

### 6.1 字段详细说明

| 字段名 | 描述 | 包含属性 |
|-------|------|---------|
| `evidence_level` | 证据置信度等级 | S, A, B, C |
| `relation_type` | 逻辑关系类型 | causal, support, contradict, related |
| `scene_tags` | 业务场景标签 | 数组形式，如 `["投研分析", "政策解读"]` |
| `source_provenance` | **多级溯源结构** | `doc_id`, `file_name`, `page_num`, `paragraph_id` |

### 6.2 向量入库字段汇总

| 字段 | 实体 | 关系 |
|------|-------|------|
| `evidence_level` | ✅ | ✅ |
| `scene_tags` | ✅ | - |
| `relation_type` | - | ✅ |
| `source_provenance` | ✅ | ✅ |

### 6.2 图谱入库字段

| 字段 | 实体 | 关系 |
|------|-------|------|
| `evidence_level` | ✅ | ✅ |
| `scene_tags` | ✅ | - |
| `relation_type` | - | ✅ |
| `source_provenance` | ✅ | ✅ |

---

## 七、提取与处理增强

### 7.1 关系提取新格式 (7字段)
系统现在支持更高维度的关系提取，LLM输出格式如下：
`relation<|>source<|>target<|>relation_type<|>evidence_level<|>keywords<|>description`

### 7.2 智能分块策略
- **证据感知的切分 (EvidenceSplitter)**: 弃用纯 token 长度切分，改为按语义段落、条款编号进行切分，确保证据完整性。
- **场景自动检测**: 在文本入库阶段，自动识别所属业务场景并打上 `scene_tags`。

## 八、修改文件清单

| 文件 | 改动内容 |
|------|---------|
| `kg/neo4j_impl.py` | 新增 `get_causal_chain()`, `aggregate_evidence()`, `cross_validate()` 及基础查询接口 |
| `operate.py` | 增加 7 字段关系提取解析逻辑、集成智能分块与场景检测 |
| `utils_graph.py` | 向量入库增加证据链字段支持 |
| `evidence_splitter.py` | 新增模块，负责按语义/条款进行证据感知的切分 |

---

*文档版本: v3.1*  
*更新时间: 2026-02-28*  
*状态: 全部已完成*
