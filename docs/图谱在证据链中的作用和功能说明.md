# 图谱在证据链中的作用与功能说明

## 一、图谱在证据链中的核心角色

### 1.1 图谱是证据链的载体

在 Evidence 证据链体系中，**图谱（图数据库）是核心载体**，承担着以下关键职责：

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Evidence 证据链体系                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   原始文档                                                          │
│       ↓                                                             │
│   ┌─────────────────────────────────────────────────────────┐      │
│   │  [EvidenceSplitter] 场景化切分                            │      │
│   │  - 按业务逻辑切分为最小证据单元                          │      │
│   │  - 标注场景标签、证据等级                                │      │
│   └─────────────────────────────────────────────────────────┘      │
│       ↓                                                             │
│   ┌──────────────────────────────────────────────── │
│   │─────────┐       [LLM 提取] 实体 + 关系 + 证据链属性                    │      │
│   │  - 关系类型: causal/support/contradict/related           │      │
│   │  - 证据等级: S/A/B/C                                     │      │
│   │  - 溯源信息: doc_id, page_num, paragraph_id              │      │
│   └─────────────────────────────────────────────────────────┘      │
│       ↓                                                             │
│   ┌─────────────────────────────────────────────────────────┐      │
│   │  [图数据库 Neo4j] 证据链存储与查询     ← 核心载体      │      │
│   │  - 实体节点: 携带证据等级、场景标签、溯源信息            │      │
│   │  - 关系边: 携带证据链类型、证据等级                      │      │
│   │  - 支持多维度检索: 等级/类型/场景/溯源                   │      │
│   └─────────────────────────────────────────────────────────┘      │
│       ↓                                                             │
│   智能查询                                                          │
│       ↓                                                             │
│   ┌─────────────────────────────────────────────────────────┐      │
│   │  [证据链推理]                                             │      │
│   │  - 因果链追溯                                            │      │
│   │  - 证据链聚合                                            │      │
│   │  - 多级溯源                                              │      │
│   └─────────────────────────────────────────────────────────┘      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、图谱节点与边的证据链属性

### 2.1 实体节点属性

```cypher
# Neo4j 实体节点结构
MERGE (n:Entity {entity_id: "央行"})
SET 
    n.entity_name = "央行",
    n.entity_type = "organization",
    n.description = "中国最高的货币金融管理机构",
    -- 证据链增强属性
    n.evidence_level = "S",           -- 证据等级
    n.scene_tags = ["政策法规", "监管机构"],  -- 场景标签
    n.source_provenance = {          -- 溯源信息
        doc_id: "md5hash...",
        file_name: "央行通知.pdf",
        file_path: "/docs/央行通知.pdf",
        page_num: 1,
        paragraph_id: "p5",
        chunk_id: "chunk_001"
    }
```

### 2.2 关系边属性

```cypher
# Neo4j 关系边结构
MATCH (s:Entity {entity_id: "银发〔2025〕18号"})
MATCH (t:Entity {entity_id: "科技创新领域"})
MERGE (s)-[r:DIRECTED]->(t)
SET
    r.keywords = "政策扩大适用,结构性货币工具",
    r.description = "该通知将适用范围扩大至科技创新领域",
    -- 证据链增强属性
    r.relation_type = "causal",      -- 证据链类型
    r.evidence_level = "S",          -- 证据等级
    r.source_provenance = {          -- 溯源信息
        doc_id: "md5hash...",
        file_name: "央行通知.pdf",
        file_path: "/docs/央行通知.pdf",
        page_num: 1,
        chunk_id: "chunk_001"
    }
```

---

## 三、图谱的证据链查询能力

### 3.1 按证据等级查询

```python
# 查询所有S级（最高证据等级）的实体
await kg.get_entities_by_evidence_level("S", limit=100)

# 查询S级证据的关系
await kg.get_relations_by_evidence_level("S", limit=100)
```

**Cypher 语义**：
```cypher
-- 查询S级实体
MATCH (n:Entity)
WHERE n.evidence_level = "S"
RETURN n

-- 查询S级关系
MATCH (s:Entity)-[r]->(t:Entity)
WHERE r.evidence_level = "S"
RETURN s, r, t
```

### 3.2 按证据链类型查询

```python
# 查询因果关系
await kg.get_relations_by_type("causal", limit=100)

# 查询支持关系
await kg.get_relations_by_type("support", limit=100)
```

**Cypher 语义**：
```cypher
-- 查询因果关系链
MATCH (s:Entity)-[r:DIRECTED]->(t:Entity)
WHERE r.relation_type = "causal"
RETURN s.entity_name, r.description, t.entity_name
```

### 3.3 按场景标签查询

```python
# 查询"投研分析"场景的实体
await kg.get_entities_by_scene("投研分析")

# 查询"风险控制"场景的关系
await kg.get_relations_by_scene("风险控制")
```

**Cypher 语义**：
```cypher
-- 查询投研分析场景的实体
MATCH (n:Entity)
WHERE ANY(tag IN n.scene_tags WHERE tag = "投研分析")
RETURN n
```

### 3.4 组合条件查询

```python
# 查询S级 + 政策法规场景的实体
await kg.get_entities_by_evidence_level_and_scene("S", "政策法规")

# 查询因果关系 + S级 + 投研分析
```

**Cypher 语义**：
```cypher
-- S级 + 政策法规
MATCH (n:Entity)
WHERE n.evidence_level = "S"
AND ANY(tag IN n.scene_tags WHERE tag = "政策法规")
RETURN n
```

### 3.5 溯源查询

```python
# 查询实体的溯源信息
await kg.get_entity_provenance("央行")

# 查询关系的溯源信息
await kg.get_relation_provenance("银发〔2025〕18号", "科技创新领域")

# 查询特定文件关联的所有实体
await kg.get_entities_by_file("/docs/央行通知.pdf")
```

**返回示例**：
```json
[
    {
        "doc_id": "abc123md5...",
        "file_name": "央行通知.pdf",
        "file_path": "/docs/央行通知.pdf",
        "page_num": 1,
        "paragraph_id": "p5",
        "chunk_id": "chunk_001"
    }
]
```

---

## 四、证据链的核心功能

### 4.1 证据等级管理

| 功能 | 说明 | 图谱实现 |
|------|------|---------|
| 等级标注 | 实体/关系携带证据等级 | 节点/边属性 `evidence_level` |
| 等级筛选 | 按等级过滤查询结果 | `get_entities_by_evidence_level()` |
| 等级排序 | 查询结果按等级排序 | Cypher `ORDER BY evidence_level` |

### 4.2 证据链关系管理

| 功能 | 说明 | 图谱实现 |
|------|------|---------|
| 关系分类 | 因果/支持/反驳/相关 | 边属性 `relation_type` |
| 关系追溯 | 从结果追溯证据链 | 路径查询 `MATCH (a)-[*]->(b)` |
| 证据链聚合 | 聚合相同类型的证据 | Cypher `COLLECT()` 聚合 |

### 4.3 精准溯源管理

| 功能 | 说明 | 图谱实现 |
|------|------|---------|
| 文档级溯源 | 追溯到原始文档 | 节点/边属性 `source_provenance` |
| 页码级溯源 | 追溯到具体页码 | `page_num` 字段 |
| 段落级溯源 | 追溯到具体段落 | `paragraph_id` 字段 |
| Chunk级溯源 | 追溯到处理的Chunk | `chunk_id` 字段 |

### 4.4 场景标签管理

| 功能 | 说明 | 图谱实现 |
|------|------|---------|
| 标签标注 | 实体/关系携带场景标签 | 节点/边属性 `scene_tags` (数组) |
| 场景检索 | 按场景标签检索 | `get_entities_by_scene()` |
| 多标签检索 | 同时满足多个标签 | Cypher `ANY(tag IN n.scene_tags WHERE ...)` |

---

## 五、证据链查询示例

### 5.1 查询"某政策对市场的影响"（因果链追溯）

```python
# 查询因果关系链
results = await kg.get_relations_by_type("causal", limit=100)

# 进一步筛选S级
s级因果 = [r for r in results if r["evidence_level"] == "S"]
```

### 5.2 查询"支持某投资观点的证据"

```python
# 查询支持关系
支持证据 = await kg.get_relations_by_type("support", limit=100)

# 按证据等级排序（优先S/A级）
高级别证据 = sorted(支持证据, 
    key=lambda x: {"S": 0, "A": 1, "B": 2, "C": 3}.get(x["evidence_level"], 4))
```

### 5.3 查询"某文件的全部关联实体"

```python
# 精准溯源到文件
文件实体 = await kg.get_entities_by_file("/docs/央行通知.pdf")

# 获取这些实体的全部关系
for entity in 文件实体:
    关系 = await kg.get_relation_provenance(entity["entity_name"], "*")
```

### 5.4 查询"政策法规场景的S级证据"

```python
# 组合查询：S级 + 政策法规
结果 = await kg.get_entities_by_evidence_level_and_scene("S", "政策法规")
```

---

## 六、图谱查询 API 汇总

### 6.1 证据等级查询

| API | 功能 |
|-----|------|
| `get_entities_by_evidence_level(level)` | 按证据等级查询实体 |
| `get_relations_by_evidence_level(level)` | 按证据等级查询关系 |

### 6.2 证据链类型查询

| API | 功能 |
|-----|------|
| `get_relations_by_type(type)` | 按证据链类型查询关系 |

### 6.3 场景标签查询

| API | 功能 |
|-----|------|
| `get_entities_by_scene(tag)` | 按场景标签查询实体 |
| `get_relations_by_scene(tag)` | 按场景标签查询关系 |
| `get_entities_by_evidence_level_and_scene(level, tag)` | 组合条件查询 |

### 6.4 溯源查询

| API | 功能 |
|-----|------|
| `get_entity_provenance(entity_name)` | 查询实体的溯源信息 |
| `get_relation_provenance(source, target)` | 查询关系的溯源信息 |
| `get_entities_by_file(file_path)` | 按文件查询关联实体 |

---

## 七、图谱在证据链中的价值

### 7.1 结构化存储

- **实体**：携带证据等级、场景标签、溯源信息
- **关系**：携带证据链类型、证据等级、支持/反驳标记
- **属性**：支持丰富的元数据存储

### 7.2 高效检索

- **多维度**：支持按等级/类型/场景/溯源多维度检索
- **组合查询**：支持复杂条件组合查询
- **路径追溯**：支持证据链路径追溯和分析

### 7.3 证据推理

- **因果链**：支持从因到果的链路追溯
- **证据聚合**：支持同类型证据的聚合分析
- **交叉验证**：支持多来源证据的交叉验证

### 7.4 精准溯源

- **文档级**：精确到原始文档
- **页码级**：精确到具体页码
- **段落级**：精确到具体段落
- **Chunk级**：精确到处理的Chunk单元

---

## 八、与传统RAG对比

| 特性 | 传统RAG | Evidence图谱RAG |
|------|---------|-----------------|
| 检索粒度 | Chunk级别 | 实体/关系级别 |
| 证据等级 | 无 | S/A/B/C四级 |
| 关系类型 | 无 | 因果/支持/反驳/相关 |
| 溯源精度 | 文档级别 | 段落/Chunk级别 |
| 场景感知 | 无 | 8大场景分类 |
| 因果追溯 | 不支持 | 支持因果链追溯 |

---

*文档版本: v1.0*  
*创建时间: 2026-02-27*  
*项目: LightRAG Evidence 证据链二次开发*

---

## 九、证据推理功能（已实现）

### 9.1 功能说明

| 功能 | 说明 | API |
|------|------|------|
| 因果链追溯 | 从某实体出发，追溯 causal 类型因果链路径 | `get_causal_chain()` |
| 证据聚合 | 聚合相同主题/类型的证据，计算权重 | `aggregate_evidence()` |
| 交叉验证 | 检测 support/contradict 关系，输出验证结论 | `cross_validate()` |

### 9.2 API 详情

```python
# 1. 因果链追溯
results = await kg.get_causal_chain(
    entity_id="降准政策",
    max_depth=5,
    evidence_level="S",
    limit=20
)

# 2. 证据聚合
results = await kg.aggregate_evidence(
    topic="科创板",
    scene_tag="投研分析",
    evidence_level="S",
    min_weight=3
)

# 3. 交叉验证
result = await kg.cross_validate(
    claim_entity="货币政策将利好股市",
    min_evidence_count=1
)
```

### 9.3 返回示例

**因果链追溯：**
```python
[
    {
        "start_entity": "降准政策",
        "end_entity": "银行负债成本降低",
        "chain_entities": [
            {"entity_id": "降准政策", "entity_name": "降准政策"},
            {"entity_id": "银行负债成本降低", "entity_name": "银行负债成本降低"}
        ],
        "chain_relations": [
            {
                "source": "降准政策",
                "target": "银行负债成本降低",
                "description": "降准释放流动性...",
                "evidence_level": "S"
            }
        ],
        "chain_length": 3,
        "chain_weight": 12
    }
]
```

**交叉验证：**
```python
{
    "claim": "货币政策将利好股市",
    "conclusion": "证据支持",
    "support_evidence": [
        {"entity": "降准", "description": "释放流动性...", "level": "S", "type": "support"}
    ],
    "contradict_evidence": [],
    "support_count": 3,
    "contradict_count": 0,
    "support_weight": 10,
    "contradict_weight": 0
}
```

### 9.4 验证结论规则

| 条件 | 结论 |
|------|------|
| support > contradict × 1.5 | 证据支持 |
| contradict > support × 1.5 | 证据反驳 |
| support > 0 且 contradict > 0 | 证据存在分歧 |
| 仅支持证据 | 证据支持(单方面) |
| 仅反驳证据 | 证据反驳(单方面) |
| 都为0 | 证据不足 |

### 9.5 证据等级权重

| 等级 | 权重 |
|------|------|
| S | 4 |
| A | 3 |
| B | 2 |
| C | 1 |

---

*文档版本: v1.1*  
*更新时间: 2026-02-27*  
*项目: LightRAG Evidence 证据链二次开发*