# GraphRAG 前端部署说明

## 目录

1. [部署方式](#部署方式)
2. [环境准备](#环境准备)
3. [Nginx部署](#Nginx部署)
4. [Docker部署](#Docker部署)
5. [生产环境配置](#生产环境配置)
6. [HTTPS配置](#HTTPS配置)
7. [性能优化](#性能优化)
8. [监控与日志](#监控与日志)

---

## 部署方式

支持的部署方式：

- **Nginx部署**（推荐）- 传统服务器部署
- **Docker部署** - 容器化部署
- **静态托管** - CDN或对象存储托管

---

## 环境准备

### 系统要求

- **操作系统**: Linux (Ubuntu 20.04+ / CentOS 8+)
- **Node.js**: 18.x 或更高
- **Nginx**: 1.20+ (如使用Nginx部署)
- **Docker**: 20.10+ (如使用Docker部署)

### 构建准备

1. 安装依赖
```bash
cd graphrag/frontend
npm install
```

2. 构建生产版本
```bash
npm run build
```

构建完成后，`dist/` 目录包含所有静态文件。

---

## Nginx部署

### 1. 安装Nginx

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install nginx
```

**CentOS/RHEL:**
```bash
sudo yum install nginx
```

### 2. 配置文件

创建配置文件 `/etc/nginx/sites-available/graphrag`：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 修改为你的域名
    
    # 前端静态文件
    location / {
        root /var/www/graphrag/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API代理 - 后端服务
    location /api/ {
        proxy_pass http://localhost:9621/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 流式响应端点 - 禁用缓冲
    location ~ ^/(query/stream|api/chat) {
        proxy_pass http://localhost:9621;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_buffering off;
        proxy_cache off;
        gzip off;
        
        # 长连接
        proxy_read_timeout 300s;
    }
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml;
}
```

### 3. 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/graphrag /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载Nginx
sudo systemctl reload nginx
```

### 4. 部署文件

```bash
# 创建目录
sudo mkdir -p /var/www/graphrag/frontend

# 复制构建文件
sudo cp -r dist/* /var/www/graphrag/frontend/dist/

# 设置权限
sudo chown -R www-data:www-data /var/www/graphrag
sudo chmod -R 755 /var/www/graphrag
```

---

## Docker部署

### 1. 创建Dockerfile

```dockerfile
# 构建阶段
FROM node:20-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY package*.json ./
RUN npm ci

# 复制源码并构建
COPY . .
RUN npm run build

# 运行阶段
FROM nginx:alpine

# 复制Nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 暴露端口
EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 2. 创建nginx.conf

```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api/ {
        proxy_pass http://host.docker.internal:9621/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. 构建镜像

```bash
docker build -t graphrag-frontend:latest .
```

### 4. 运行容器

```bash
docker run -d \
  --name graphrag-frontend \
  -p 80:80 \
  --add-host=host.docker.internal:host-gateway \
  graphrag-frontend:latest
```

### 5. Docker Compose配置

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  frontend:
    build:
      context: ./graphrag/frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    environment:
      - NGINX_HOST=localhost
      - NGINX_PORT=80
    networks:
      - graphrag-network
    restart: unless-stopped

networks:
  graphrag-network:
    driver: bridge
```

运行：
```bash
docker-compose up -d
```

---

## 生产环境配置

### 环境变量

创建 `.env.production`：

```bash
# API基础URL（相对路径，通过Nginx代理）
VITE_API_URL=/api

# 应用标题
VITE_APP_TITLE=GraphRAG

# 是否启用调试
VITE_DEBUG=false
```

### 构建优化

```bash
# 使用生产环境变量构建
npm run build -- --mode production
```

### 静态资源CDN

如需使用CDN加速，修改 `vite.config.ts`：

```typescript
export default defineConfig({
  base: 'https://cdn.your-domain.com/graphrag/',
  // ...
})
```

---

## HTTPS配置

### 使用 Let's Encrypt

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

### Nginx HTTPS配置

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL证书
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # 其他配置...
    location / {
        root /var/www/graphrag/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 性能优化

### 1. 开启Gzip压缩

已在Nginx配置中包含，确保启用：
```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript;
```

### 2. 静态资源缓存

```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    access_log off;
}
```

### 3. 启用Brotli压缩（可选）

```bash
# 安装Brotli模块
sudo apt install nginx-extras
```

```nginx
brotli on;
brotli_comp_level 6;
brotli_types text/plain text/css application/json application/javascript;
```

### 4. 资源预加载

在 `index.html` 中添加：
```html
<link rel="preload" href="/src/main.tsx" as="script">
<link rel="preconnect" href="https://api.your-domain.com">
```

---

## 监控与日志

### Nginx日志配置

```nginx
# 访问日志
access_log /var/log/nginx/graphrag-access.log combined;

# 错误日志
error_log /var/log/nginx/graphrag-error.log warn;

# 自定义日志格式
log_format graphrag '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    '$request_time $upstream_response_time';

access_log /var/log/nginx/graphrag-access.log graphrag;
```

### 日志轮转

创建 `/etc/logrotate.d/graphrag`：

```
/var/log/nginx/graphrag-*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

### 健康检查

添加健康检查端点：

```nginx
location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}
```

---

## 故障排除

### 问题1：404错误

**原因**：刷新页面后404

**解决**：确保Nginx配置中有 `try_files`：
```nginx
try_files $uri $uri/ /index.html;
```

### 问题2：API请求失败

**检查**：
1. 后端服务是否运行
2. Nginx代理配置是否正确
3. 防火墙是否开放端口

### 问题3：静态资源加载慢

**优化**：
1. 启用Gzip/Brotli压缩
2. 配置浏览器缓存
3. 使用CDN加速

### 问题4：内存不足

**解决**：
```bash
# 增加Node构建内存限制
NODE_OPTIONS="--max-old-space-size=4096" npm run build
```

---

## 部署清单

部署前检查项：

- [ ] 已完成生产环境构建
- [ ] 已配置正确的API地址
- [ ] 已安装并配置Nginx
- [ ] 已配置SSL证书（生产环境）
- [ ] 已配置防火墙规则
- [ ] 已配置日志轮转
- [ ] 已测试所有功能正常
- [ ] 已配置监控告警

---

## 更新部署

### 热更新（不中断服务）

```bash
# 1. 构建新版本
npm run build

# 2. 复制到新目录
sudo cp -r dist /var/www/graphrag/frontend/dist-new

# 3. 原子替换
sudo mv /var/www/graphrag/frontend/dist /var/www/graphrag/frontend/dist-old
sudo mv /var/www/graphrag/frontend/dist-new /var/www/graphrag/frontend/dist

# 4. 清理旧版本
sudo rm -rf /var/www/graphrag/frontend/dist-old
```

### 回滚

```bash
# 快速回滚到上一版本
sudo mv /var/www/graphrag/frontend/dist /var/www/graphrag/frontend/dist-failed
sudo mv /var/www/graphrag/frontend/dist-old /var/www/graphrag/frontend/dist
sudo nginx -s reload
```

---

## 安全建议

1. **隐藏版本信息**
```nginx
server_tokens off;
```

2. **限制请求频率**
```nginx
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req zone=api burst=20 nodelay;
```

3. **安全响应头**
```nginx
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
```

---

**文档版本**: v1.0.0  
**更新日期**: 2026-02-07  
**维护者**: GraphRAG Team
