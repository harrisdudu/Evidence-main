# LightRAG WebUI 迁移至 GraphRAG 3.0 完整方案

## 目录

1. [项目概述](#项目概述)
2. [迁移策略](#迁移策略)
3. [技术架构](#技术架构)
4. [目录结构](#目录结构)
5. [功能模块详解](#功能模块详解)
6. [实施步骤](#实施步骤)
7. [配置说明](#配置说明)
8. [使用指南](#使用指南)
9. [API接口文档](#API接口文档)
10. [常见问题](#常见问题)

---

## 项目概述

### 迁移背景

本项目将 **LightRAG WebUI** 的前端功能完整迁移至 **GraphRAG 3.0** 项目中。LightRAG WebUI 是一个基于 React + TypeScript 的现代化前端项目，提供了文档管理、知识图谱可视化、检索测试等核心功能。

### 迁移目标

- **保留功能完整性**：确保所有原有功能正常工作
- **技术栈升级**：采用最新的 React 19 和相关技术栈
- **代码结构优化**：采用更清晰的目录组织和模块划分
- **性能优化**：提升加载速度和运行时性能
- **可维护性**：提高代码可读性和可维护性

### 新增功能

- **仪表板模块**：新增系统概览仪表板，提供文档统计和健康状态监控
- **响应式布局**：优化移动端和桌面端的显示效果
- **主题切换**：支持亮色/暗色主题自动切换

---

## 迁移策略

### 迁移原则

1. **渐进式迁移**：分阶段实施，确保每个阶段都可测试验证
2. **功能对等**：新实现与原有功能完全对等，不丢失任何特性
3. **向后兼容**：保持与后端 API 的兼容性
4. **代码复用**：最大程度复用原有业务逻辑和组件

### 迁移范围

| 模块 | 迁移内容 | 优先级 |
|------|----------|--------|
| UI组件 | Button, Card, Input, Table, Badge等基础组件 | P0 |
| 状态管理 | Auth, Graph, Documents, Settings四个Store | P0 |
| API层 | 所有API客户端和类型定义 | P0 |
| 文档管理 | 文档列表、上传、删除、状态跟踪 | P0 |
| 知识图谱 | Sigma.js可视化、力导向布局、节点交互 | P0 |
| 检索测试 | 多模式查询、流式响应、对话历史 | P0 |
| 仪表板 | 新增统计仪表板 | P1 |
| 路由布局 | React Router配置、侧边栏布局 | P0 |

---

## 技术架构

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 19.x | UI框架 |
| TypeScript | 5.6+ | 类型系统 |
| Vite | 6.x | 构建工具 |
| Tailwind CSS | 3.4+ | 样式框架 |
| Zustand | 5.x | 状态管理 |
| React Router | 7.x | 路由管理 |
| Sigma.js | 3.x | 图谱可视化 |
| Graphology | 0.26+ | 图数据结构 |
| Radix UI | 最新 | 基础组件库 |
| Axios | 1.7+ | HTTP客户端 |
| Lucide React | 最新 | 图标库 |
| Sonner | 最新 | 消息通知 |

### 架构特点

1. **组件化设计**：UI组件与业务逻辑分离
2. **状态集中管理**：使用 Zustand 实现全局状态管理
3. **模块化组织**：按功能模块组织代码（features目录）
4. **类型安全**：全项目 TypeScript 类型覆盖
5. **响应式设计**：适配不同屏幕尺寸

---

## 目录结构

```
graphrag/frontend/
├── package.json              # 项目依赖配置
├── vite.config.ts            # Vite构建配置
├── tsconfig.json             # TypeScript配置
├── tsconfig.node.json        # Node类型配置
├── tailwind.config.js        # Tailwind样式配置
├── postcss.config.js         # PostCSS配置
├── index.html                # HTML入口
├── README.md                 # 项目说明
│
├── public/                   # 静态资源
│   └── vite.svg             # Logo图标
│
└── src/                      # 源代码目录
    │
    ├── api/                  # API层
    │   ├── types.ts         # 类型定义
    │   └── client.ts        # API客户端
    │
    ├── components/          # 组件目录
    │   ├── ui/             # UI基础组件
    │   │   ├── button.tsx
    │   │   ├── card.tsx
    │   │   ├── input.tsx
    │   │   ├── badge.tsx
    │   │   ├── table.tsx
    │   │   ├── checkbox.tsx
    │   │   ├── tabs.tsx
    │   │   ├── label.tsx
    │   │   └── textarea.tsx
    │   │
    │   └── layout/         # 布局组件
    │       └── Layout.tsx  # 主布局（含侧边栏）
    │
    ├── features/           # 功能模块
    │   ├── documents/      # 文档管理模块
    │   │   └── index.tsx
    │   │
    │   ├── graph/          # 知识图谱模块
    │   │   └── index.tsx
    │   │
    │   ├── retrieval/      # 检索测试模块
    │   │   └── index.tsx
    │   │
    │   ├── dashboard/      # 仪表板模块（新增）
    │   │   └── index.tsx
    │   │
    │   └── login/          # 登录页面
    │       └── index.tsx
    │
    ├── stores/             # 状态管理
    │   ├── auth.ts        # 认证状态
    │   ├── documents.ts   # 文档状态
    │   ├── graph.ts       # 图谱状态
    │   └── settings.ts    # 设置状态
    │
    ├── lib/               # 工具库
    │   └── utils.ts       # 工具函数
    │
    ├── App.tsx            # 应用入口组件
    ├── main.tsx           # 主渲染入口
    └── index.css          # 全局样式
```

---

## 功能模块详解

### 1. 文档管理模块 (Documents)

**功能列表：**
- 文档列表展示（表格形式）
- 文档状态实时跟踪（pending/processing/preprocessed/processed/failed）
- 批量选择和删除操作
- 自动刷新（每5秒）
- 文档扫描
- 状态筛选和排序

**核心组件：**
- 文档列表表格
- 操作按钮组（刷新、扫描、上传、删除）
- 状态标签显示

**状态管理：**
```typescript
interface DocumentState {
  documents: Document[]          // 文档列表
  isLoading: boolean             // 加载状态
  selectedIds: Set<string>       // 选中项
  statusCounts: Record<string, number>  // 状态统计
}
```

### 2. 知识图谱模块 (Graph)

**功能列表：**
- Sigma.js 图谱可视化
- 力导向布局（ForceAtlas2算法）
- 节点交互（点击选中、悬停高亮）
- 图谱数据动态加载
- 节点和边的属性查看
- 图谱刷新和重新布局

**技术实现：**
- 使用 `@react-sigma/core` 组件库
- 支持曲线边渲染
- 响应式缩放和平移
- 自定义节点样式

**核心配置：**
```typescript
const sigmaSettings = {
  defaultNodeType: 'border',
  defaultEdgeType: 'curvedNoArrow',
  nodeProgramClasses: { border: NodeBorderProgram },
  edgeProgramClasses: { curvedNoArrow: createEdgeCurveProgram() },
}
```

### 3. 检索测试模块 (Retrieval)

**功能列表：**
- 多模式查询（naive/local/global/hybrid/mix）
- 流式响应显示
- 对话历史记录
- 查询模式切换
- 清空对话

**查询模式说明：**
| 模式 | 说明 |
|------|------|
| naive | 基础向量检索 |
| local | 本地上下文检索 |
| global | 全局知识检索 |
| hybrid | 混合检索（本地+全局）|
| mix | 知识图谱+向量融合检索 |

**流式处理：**
- 使用 Fetch API 的 ReadableStream
- 实时解析 NDJSON 格式
- 动态更新消息内容

### 4. 仪表板模块 (Dashboard) - 新增

**功能列表：**
- 文档统计卡片（总数、已处理、待处理、失败）
- 系统健康状态显示
- 版本信息展示
- 快速导航提示

**统计指标：**
- 文档总数
- 已处理文档数
- 待处理文档数
- 失败文档数
- 系统运行状态
- 软件版本号

### 5. 用户认证模块

**功能列表：**
- JWT Token 认证
- 游客模式支持
- 登录/登出功能
- Token 自动刷新
- 认证状态持久化

**认证流程：**
1. 访问 `/login` 页面
2. 输入用户名密码
3. 调用 `/login` API 获取 Token
4. 存储 Token 到 localStorage
5. 后续请求自动携带 Token
6. Token 过期自动跳转登录页

---

## 实施步骤

### 第一阶段：基础架构搭建（Day 1-2）

**任务清单：**
1. 创建项目目录结构
2. 初始化 package.json 和依赖
3. 配置 Vite、TypeScript、Tailwind
4. 创建全局样式文件
5. 配置路径别名 (@/*)

**关键文件：**
- `package.json` - 项目配置
- `vite.config.ts` - 构建配置
- `tsconfig.json` - TypeScript配置
- `tailwind.config.js` - 样式配置

### 第二阶段：UI组件迁移（Day 2-3）

**迁移组件列表：**
- Button - 按钮组件
- Card - 卡片组件
- Input - 输入框组件
- Badge - 标签组件
- Table - 表格组件
- Checkbox - 复选框组件
- Tabs - 标签页组件
- Label - 标签组件
- Textarea - 文本域组件

**迁移原则：**
- 保持原有功能不变
- 适配 Tailwind CSS 样式
- 添加 TypeScript 类型定义

### 第三阶段：状态管理实现（Day 3-4）

**Store实现：**
1. **Auth Store** - 认证状态管理
   - 登录/登出
   - Token管理
   - 用户信息

2. **Documents Store** - 文档状态管理
   - 文档列表
   - 选中状态
   - 状态统计

3. **Graph Store** - 图谱状态管理
   - 节点数据
   - 边数据
   - 选中状态
   - Sigma实例

4. **Settings Store** - 设置状态管理
   - 主题设置
   - 语言设置
   - API配置

### 第四阶段：API层适配（Day 4-5）

**实现内容：**
- 类型定义文件（types.ts）
- API客户端（client.ts）
- Axios拦截器配置
- 错误处理逻辑

**API分组：**
- Documents API - 文档相关
- Graph API - 图谱相关
- Query API - 查询相关
- Auth API - 认证相关
- Health API - 健康检查

### 第五阶段：功能模块实现（Day 5-10）

**模块开发顺序：**
1. Layout组件 - 页面布局框架
2. Dashboard模块 - 仪表板
3. Documents模块 - 文档管理
4. Graph模块 - 知识图谱
5. Retrieval模块 - 检索测试
6. Login模块 - 登录页面

### 第六阶段：路由配置（Day 10）

**路由结构：**
```
/              -> Dashboard（默认）
/documents     -> Documents
/graph         -> Graph
/retrieval     -> Retrieval
/login         -> Login
```

**路由特性：**
- 受保护路由（需要登录）
- 默认重定向
- 404处理

---

## 配置说明

### 开发环境配置

**Vite配置：**
```typescript
// vite.config.ts
export default defineConfig({
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:9621',
        changeOrigin: true,
      },
    },
  },
})
```

**环境变量：**
```bash
# .env
VITE_API_URL=http://localhost:9621
```

### 生产环境配置

**构建配置：**
```bash
npm run build
# 输出目录：dist/
```

**Nginx配置示例：**
```nginx
server {
    listen 80;
    server_name graphrag.local;
    
    location / {
        root /path/to/graphrag/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://localhost:9621;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 主题配置

**Tailwind主题变量：**
```css
:root {
  --background: 0 0% 100%;
  --foreground: 222.2 84% 4.9%;
  --primary: 160 84% 39%;  /* emerald-500 */
  --primary-foreground: 0 0% 100%;
}

.dark {
  --background: 222.2 84% 4.9%;
  --foreground: 210 40% 98%;
  --primary: 160 84% 39%;
  --primary-foreground: 0 0% 100%;
}
```

---

## 使用指南

### 安装依赖

```bash
cd graphrag/frontend

# 使用 npm
npm install

# 或使用 bun（推荐）
bun install
```

### 启动开发服务器

```bash
# 开发模式
npm run dev

# 访问 http://localhost:3000
```

### 构建生产版本

```bash
# 构建
npm run build

# 预览生产版本
npm run preview
```

### 代码检查

```bash
# TypeScript检查
npx tsc --noEmit

# ESLint检查
npm run lint
```

---

## API接口文档

### 认证接口

#### 获取认证状态
```http
GET /auth-status
```

**响应：**
```json
{
  "auth_configured": true,
  "access_token": "...",
  "auth_mode": "enabled"
}
```

#### 用户登录
```http
POST /login
Content-Type: multipart/form-data

username=admin&password=admin123
```

**响应：**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "token_type": "bearer",
  "core_version": "1.4.9",
  "api_version": "1.0.0"
}
```

### 文档接口

#### 获取所有文档
```http
GET /documents
```

**响应：**
```json
{
  "statuses": {
    "processed": [...],
    "pending": [...],
    "failed": [...]
  }
}
```

#### 上传文档
```http
POST /documents/upload
Content-Type: multipart/form-data

file: <文件内容>
```

#### 删除文档
```http
DELETE /documents/delete_document
Content-Type: application/json

{
  "doc_ids": ["id1", "id2"],
  "delete_file": false,
  "delete_llm_cache": false
}
```

### 图谱接口

#### 查询图谱
```http
GET /graphs?label=*&max_depth=3&max_nodes=1000
```

**响应：**
```json
{
  "nodes": [
    {
      "id": "Node1",
      "labels": ["Entity"],
      "properties": {}
    }
  ],
  "edges": [
    {
      "id": "edge1",
      "source": "Node1",
      "target": "Node2",
      "properties": {}
    }
  ]
}
```

### 查询接口

#### 普通查询
```http
POST /query
Content-Type: application/json

{
  "query": "What is GraphRAG?",
  "mode": "mix",
  "stream": false
}
```

#### 流式查询
```http
POST /query/stream
Content-Type: application/json
Accept: application/x-ndjson

{
  "query": "What is GraphRAG?",
  "mode": "mix",
  "stream": true
}
```

**响应（流式）：**
```
{"response": "GraphRAG is..."}
{"response": " a graph-based..."}
...
```

### 健康检查

```http
GET /health
```

**响应：**
```json
{
  "status": "healthy",
  "working_directory": "./rag_storage",
  "configuration": {...},
  "core_version": "1.4.9",
  "api_version": "1.0.0"
}
```

---

## 常见问题

### Q1: 如何处理跨域问题？

**A:** 在开发环境中，Vite 配置已包含代理设置。生产环境需要在 Nginx 中配置反向代理，或后端开启 CORS。

### Q2: Token过期后如何处理？

**A:** API拦截器会自动检测401状态码，清除本地Token并跳转到登录页面。

### Q3: 如何添加新的查询模式？

**A:** 
1. 在 `api/types.ts` 中添加新的模式类型
2. 在检索页面的 Select 组件中添加选项
3. 后端需要支持该模式的处理逻辑

### Q4: Sigma.js图谱不显示？

**A:** 
1. 确保已导入 `@react-sigma/core/lib/style.css`
2. 检查图谱数据格式是否正确
3. 查看浏览器控制台是否有错误信息
4. 确认容器有明确的宽高

### Q5: 如何修改主题颜色？

**A:** 
1. 编辑 `tailwind.config.js` 中的 colors 配置
2. 修改 `src/index.css` 中的 CSS 变量
3. 重新编译项目

### Q6: 如何添加新的功能模块？

**A:**
1. 在 `src/features/` 下创建新目录
2. 创建 `index.tsx` 作为模块入口
3. 在 `App.tsx` 中添加路由配置
4. 在 `Layout.tsx` 的侧边栏中添加导航项

---

## 迁移对比

### LightRAG WebUI vs GraphRAG Frontend

| 特性 | LightRAG WebUI | GraphRAG Frontend |
|------|----------------|-------------------|
| React版本 | 18.x | 19.x |
| 路由 | HashRouter | BrowserRouter |
| 布局 | 顶部Tab导航 | 左侧边栏导航 |
| 新增功能 | - | 仪表板模块 |
| 代码组织 | features平铺 | 模块化features |
| 主题 | 手动切换 | 自动+手动切换 |

### 保持兼容的部分

- API接口调用方式
- 状态管理逻辑
- Sigma.js图谱配置
- 文档数据结构
- 查询参数格式

---

## 后续优化建议

1. **性能优化**
   - 实现虚拟滚动（大数据量表格）
   - 图谱数据分页加载
   - 组件懒加载

2. **功能增强**
   - 文档预览功能
   - 图谱导出图片
   - 查询历史保存
   - 多语言完整支持

3. **测试覆盖**
   - 单元测试（Jest/Vitest）
   - E2E测试（Playwright）
   - 视觉回归测试

4. **监控分析**
   - 错误监控（Sentry）
   - 性能监控
   - 用户行为分析

---

## 文档维护

- **创建日期**: 2026-02-07
- **版本**: v1.0.0
- **维护者**: GraphRAG Team
- **更新记录**:
  - 2026-02-07: 初始版本，完成基础迁移

---

**注意**: 本文档为迁移方案说明，具体实现代码请参考 `graphrag/frontend/` 目录下的源代码文件。
