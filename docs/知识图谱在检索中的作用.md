# çŸ¥è¯†å›¾è°±åœ¨æ£€ç´¢ä¸­çš„ä½œç”¨ - å®Œæ•´å®ç°æ–¹æ¡ˆ

## ç›®å½•
1. [çŸ¥è¯†å›¾è°±æ£€ç´¢çš„æ ¸å¿ƒä»·å€¼](#çŸ¥è¯†å›¾è°±æ£€ç´¢çš„æ ¸å¿ƒä»·å€¼)
2. [å…­ç§æŸ¥è¯¢æ¨¡å¼è¯¦è§£](#å…­ç§æŸ¥è¯¢æ¨¡å¼è¯¦è§£)
3. [åç«¯å®ç°æœºåˆ¶](#åç«¯å®ç°æœºåˆ¶)
4. [å‰ç«¯å±•ç¤ºæ–¹æ¡ˆ](#å‰ç«¯å±•ç¤ºæ–¹æ¡ˆ)
5. [å®è·µç¤ºä¾‹](#å®è·µç¤ºä¾‹)
6. [æ€§èƒ½å¯¹æ¯”](#æ€§èƒ½å¯¹æ¯”)

---

## çŸ¥è¯†å›¾è°±æ£€ç´¢çš„æ ¸å¿ƒä»·å€¼

### 1.1 ä¼ ç»ŸRAG vs çŸ¥è¯†å›¾è°±RAG

```
ä¼ ç»ŸRAGï¼ˆå‘é‡æ£€ç´¢ï¼‰:          çŸ¥è¯†å›¾è°±RAG:
Query â†’ å‘é‡ç›¸ä¼¼åº¦æœç´¢ â†’      Query â†’ å®ä½“è¯†åˆ« â†’ å›¾è°±éå† â†’
       æ–‡æœ¬å— â†’ LLM                    å¤šç»´åº¦å…³è” â†’ LLM
```

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- **è¯­ä¹‰å…³è”**ï¼šä¸ä»…åŒ¹é…å…³é”®è¯ï¼Œè¿˜èƒ½ç†è§£å®ä½“é—´çš„å…³ç³»
- **å¤šè·³æ¨ç†**ï¼šæ”¯æŒè·¨æ–‡æ¡£çš„å¤æ‚å…³è”æŸ¥è¯¢
- **ç»“æ„åŒ–ä¸Šä¸‹æ–‡**ï¼šæä¾›å±‚æ¬¡åŒ–çš„ä¿¡æ¯ç»„ç»‡
- **å¯è§£é‡Šæ€§**ï¼šå¯ä»¥è¿½è¸ªç­”æ¡ˆçš„æ¥æºè·¯å¾„

### 1.2 æ£€ç´¢æµç¨‹æ¶æ„

```
ç”¨æˆ·æŸ¥è¯¢
    â†“
å…³é”®è¯æå– (HL/LL Keywords)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           çŸ¥è¯†å›¾è°±æ£€ç´¢å±‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ å®ä½“åŒ¹é…  â”‚  â”‚ å…³ç³»å‘ç°  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â†“             â†“                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ é‚»å±…æ‰©å±•  â”‚  â”‚ è·¯å¾„å‘ç°  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚              â†“                        â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚      â”‚ ç›¸å…³æ–‡æœ¬å—æ±‡èš â”‚                â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ä¸Šä¸‹æ–‡æ„å»º
    â†“
LLMç”Ÿæˆå›ç­”
```

---

## å…­ç§æŸ¥è¯¢æ¨¡å¼è¯¦è§£

### 2.1 æ¨¡å¼å¯¹æ¯”è¡¨

| æ¨¡å¼ | ä½¿ç”¨çŸ¥è¯†å›¾è°± | ä½¿ç”¨å‘é‡æ£€ç´¢ | é€‚ç”¨åœºæ™¯ | å“åº”é€Ÿåº¦ |
|------|------------|------------|---------|---------|
| **naive** | âŒ | âœ… çº¯å‘é‡ | ç®€å•äº‹å®æŸ¥è¯¢ | å¿« |
| **local** | âœ… å±€éƒ¨å­å›¾ | âŒ | å®ä½“-centricæŸ¥è¯¢ | ä¸­ç­‰ |
| **global** | âœ… å…¨å±€ç»“æ„ | âŒ | ä¸»é¢˜/æ¦‚å¿µæŸ¥è¯¢ | ä¸­ç­‰ |
| **hybrid** | âœ… ä¸¤è€…ç»“åˆ | âœ… | å¤æ‚ç»¼åˆæ€§æŸ¥è¯¢ | è¾ƒæ…¢ |
| **mix** | âœ… å›¾è°±+å‘é‡ | âœ… | æœ€å…¨é¢çš„æ£€ç´¢ | è¾ƒæ…¢ |
| **bypass** | âŒ | âŒ ç›´é—®LLM | é—²èŠ/å¸¸è¯†é—®é¢˜ | æœ€å¿« |

### 2.2 å„æ¨¡å¼æ·±åº¦è§£æ

#### 2.2.1 Localæ¨¡å¼ï¼ˆå±€éƒ¨æ£€ç´¢ï¼‰

**åŸç†ï¼š**
```python
# æ ¸å¿ƒæµç¨‹
1. æå–æŸ¥è¯¢ä¸­çš„å®ä½“
2. åœ¨çŸ¥è¯†å›¾è°±ä¸­åŒ¹é…ç›¸ä¼¼å®ä½“
3. è·å–å®ä½“çš„ç›´æ¥é‚»å±…ï¼ˆ1-hopï¼‰
4. æ”¶é›†ç›¸å…³çš„å…³ç³»å’Œæ–‡æœ¬å—
```

**é€‚ç”¨åœºæ™¯ï¼š**
- "è°æ˜¯çº¦ç¿°çš„åˆä½œä¼™ä¼´ï¼Ÿ"
- "å…¬å¸çš„CEOæ˜¯è°ï¼Ÿ"
- "æŸä¸ªäº§å“çš„ä¾›åº”å•†æœ‰å“ªäº›ï¼Ÿ"

**å®ç°ä»£ç ï¼š**
```python
async def _get_node_data(query, knowledge_graph, entities_vdb, query_param):
    # 1. å‘é‡æœç´¢ç›¸ä¼¼å®ä½“
    results = await entities_vdb.query(query, top_k=query_param.top_k)
    
    # 2. è·å–å®ä½“è¯¦ç»†ä¿¡æ¯
    node_ids = [r["entity_name"] for r in results]
    nodes_dict = await knowledge_graph_inst.get_nodes_batch(node_ids)
    
    # 3. è·å–å®ä½“åº¦æ•°ï¼ˆé‡è¦æ€§æŒ‡æ ‡ï¼‰
    degrees_dict = await knowledge_graph_inst.node_degrees_batch(node_ids)
    
    # 4. æŸ¥æ‰¾ç›¸å…³è¾¹ï¼ˆå…³ç³»ï¼‰
    use_relations = await _find_most_related_edges_from_entities(
        node_datas, query_param, knowledge_graph_inst
    )
    
    return node_datas, use_relations
```

#### 2.2.2 Globalæ¨¡å¼ï¼ˆå…¨å±€æ£€ç´¢ï¼‰

**åŸç†ï¼š**
```python
# æ ¸å¿ƒæµç¨‹
1. æå–é«˜çº§æ¦‚å¿µ/ä¸»é¢˜å…³é”®è¯
2. åœ¨çŸ¥è¯†å›¾è°±ä¸­å‘ç°ç›¸å…³å…³ç³»ï¼ˆä¸æŒ‰å®ä½“ï¼‰
3. åŸºäºå…³ç³»æƒé‡å’Œåº¦æ•°æ’åº
4. æ”¶é›†è·¨å®ä½“çš„å…¨å±€ä¿¡æ¯
```

**é€‚ç”¨åœºæ™¯ï¼š**
- "è¿™ä¸ªé¢†åŸŸçš„è¶‹åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ"
- "ä¸»è¦çš„ç«äº‰å…³ç³»æœ‰å“ªäº›ï¼Ÿ"
- "æ•´ä¸ªè¡Œä¸šçš„å‘å±•å†ç¨‹"

**ä¸Localçš„åŒºåˆ«ï¼š**
- Local: ä»å®ä½“å‡ºå‘ â†’ æ‰¾é‚»å±…
- Global: ä»å…³ç³»å‡ºå‘ â†’ æ‰¾æ¨¡å¼

#### 2.2.3 Hybridæ¨¡å¼ï¼ˆæ··åˆæ£€ç´¢ï¼‰

**åŸç†ï¼š**
```
ä¸Šä¸‹æ–‡ = Localæ£€ç´¢ç»“æœ + Globalæ£€ç´¢ç»“æœ
        â†“                    â†“
   å®ä½“-centricä¿¡æ¯     ä¸»é¢˜-centricä¿¡æ¯
```

**ä¼˜åŠ¿ï¼š**
- æ—¢æœ‰å…·ä½“çš„å®ä½“ä¿¡æ¯
- åˆæœ‰å®è§‚çš„ä¸»é¢˜èƒŒæ™¯
- æœ€å…¨é¢çš„ä¿¡æ¯è¦†ç›–

**å®ç°é€»è¾‘ï¼š**
```python
if query_param.mode == "hybrid":
    # åŒæ—¶è·å–localå’Œglobalçš„ç»“æœ
    local_context = await _build_local_context(...)
    global_context = await _build_global_context(...)
    final_context = merge_contexts(local_context, global_context)
```

#### 2.2.4 Mixæ¨¡å¼ï¼ˆå›¾è°±+å‘é‡èåˆï¼‰

**åŸç†ï¼š**
```
çŸ¥è¯†å›¾è°±ä¸Šä¸‹æ–‡ï¼ˆå®ä½“+å…³ç³»ï¼‰
        +
å‘é‡æ£€ç´¢ä¸Šä¸‹æ–‡ï¼ˆæ–‡æœ¬å—ï¼‰
        â†“
    ç»Ÿä¸€æ’åºå’Œæˆªæ–­
        â†“
    ç”Ÿæˆæœ€ç»ˆä¸Šä¸‹æ–‡
```

**å››é˜¶æ®µæ¶æ„ï¼š**
1. **Searchï¼ˆæœç´¢ï¼‰**: å¹¶è¡Œæ‰§è¡Œå›¾è°±æœç´¢å’Œå‘é‡æœç´¢
2. **Truncateï¼ˆæˆªæ–­ï¼‰**: æ ¹æ®tokené¢„ç®—è£å‰ªç»“æœ
3. **Mergeï¼ˆåˆå¹¶ï¼‰**: å»é‡å¹¶èåˆä¸¤ç§æ¥æºçš„ç»“æœ
4. **Buildï¼ˆæ„å»ºï¼‰**: æ ¼å¼åŒ–ä¸ºLLMå¯ç”¨çš„ä¸Šä¸‹æ–‡

```python
async def _build_query_context(...):
    # Stage 1: Pure search
    search_result = await _perform_kg_search(...)  # å›¾è°±æœç´¢
    vector_chunks = await _search_vectors(...)      # å‘é‡æœç´¢
    
    # Stage 2: Apply token truncation
    truncation_result = await _apply_token_truncation(...)
    
    # Stage 3: Merge chunks
    merged_chunks = await _merge_all_chunks(
        filtered_entities=...,
        filtered_relations=...,
        vector_chunks=...,
    )
    
    # Stage 4: Build final context
    context, raw_data = await _build_context_str(...)
    return QueryContextResult(context=context, raw_data=raw_data)
```

#### 2.2.5 Naiveæ¨¡å¼ï¼ˆçº¯å‘é‡æ£€ç´¢ï¼‰

**ç‰¹ç‚¹ï¼š**
- ä¸ä½¿ç”¨çŸ¥è¯†å›¾è°±
- ä»…åŸºäºå‘é‡ç›¸ä¼¼åº¦æ£€ç´¢æ–‡æœ¬å—
- é€‚åˆç®€å•çš„äº‹å®æ€§é—®é¢˜
- é€Ÿåº¦æœ€å¿«

**å®ç°ï¼š**
```python
async def naive_query(query, chunks_vdb, ...):
    # ç›´æ¥å‘é‡æœç´¢æ–‡æœ¬å—
    results = await chunks_vdb.query(query, top_k=top_k)
    return results
```

#### 2.2.6 Bypassæ¨¡å¼ï¼ˆç›´é—®LLMï¼‰

**ç‰¹ç‚¹ï¼š**
- å®Œå…¨ç»•è¿‡æ£€ç´¢
- ç›´æ¥å°†é—®é¢˜ç»™LLM
- é€‚åˆå¸¸è¯†æ€§ã€é—²èŠç±»é—®é¢˜
- ä¸ä¾èµ–ä»»ä½•å¤–éƒ¨çŸ¥è¯†

---

## åç«¯å®ç°æœºåˆ¶

### 3.1 æ ¸å¿ƒæ•°æ®æµ

```python
# lightrag/operate.py - kg_queryå‡½æ•°

async def kg_query(
    query: str,
    knowledge_graph_inst: BaseGraphStorage,      # çŸ¥è¯†å›¾è°±å­˜å‚¨
    entities_vdb: BaseVectorStorage,              # å®ä½“å‘é‡åº“
    relationships_vdb: BaseVectorStorage,         # å…³ç³»å‘é‡åº“
    text_chunks_db: BaseKVStorage,                # æ–‡æœ¬å—å­˜å‚¨
    query_param: QueryParam,                      # æŸ¥è¯¢å‚æ•°
    ...
) -> QueryResult:
    
    # Step 1: æå–å…³é”®è¯
    hl_keywords, ll_keywords = await get_keywords_from_query(...)
    # HL (High-Level): æŠ½è±¡æ¦‚å¿µè¯
    # LL (Low-Level): å…·ä½“å®ä½“è¯
    
    # Step 2: æ„å»ºæŸ¥è¯¢ä¸Šä¸‹æ–‡
    context_result = await _build_query_context(
        query, ll_keywords, hl_keywords,
        knowledge_graph_inst, entities_vdb, relationships_vdb,
        text_chunks_db, query_param
    )
    
    # Step 3: ç”ŸæˆLLMæç¤º
    sys_prompt = PROMPTS["rag_response"].format(
        context_data=context_result.context,
        response_type=query_param.response_type,
    )
    
    # Step 4: è°ƒç”¨LLM
    response = await use_model_func(
        query, system_prompt=sys_prompt, ...
    )
    
    return QueryResult(content=response, raw_data=context_result.raw_data)
```

### 3.2 å››é˜¶æ®µæ£€ç´¢æ¶æ„

```python
async def _build_query_context(...):
    """
    Stage 1: Searchï¼ˆæœç´¢ï¼‰
    - å®ä½“å‘é‡æœç´¢
    - å…³ç³»å‘é‡æœç´¢
    - å›¾è°±ç»“æ„éå†
    """
    search_result = await _perform_kg_search(...)
    
    """
    Stage 2: Truncateï¼ˆæˆªæ–­ï¼‰
    - æ ¹æ®max_entity_tokensé™åˆ¶å®ä½“æ•°é‡
    - æ ¹æ®max_relation_tokensé™åˆ¶å…³ç³»æ•°é‡
    - ä¼˜å…ˆçº§æ’åºï¼ˆåº¦æ•°ã€æƒé‡ã€ç›¸ä¼¼åº¦ï¼‰
    """
    truncation_result = await _apply_token_truncation(...)
    
    """
    Stage 3: Mergeï¼ˆåˆå¹¶ï¼‰
    - å®ä½“ç›¸å…³æ–‡æœ¬å—
    - å…³ç³»ç›¸å…³æ–‡æœ¬å—
    - å‘é‡æ£€ç´¢æ–‡æœ¬å—ï¼ˆä»…mixæ¨¡å¼ï¼‰
    - å»é‡å’Œæ’åº
    """
    merged_chunks = await _merge_all_chunks(...)
    
    """
    Stage 4: Buildï¼ˆæ„å»ºï¼‰
    - æ ¼å¼åŒ–ä¸ºæ–‡æœ¬ä¸Šä¸‹æ–‡
    - æ„å»ºmetadataï¼ˆå®ä½“æ•°ã€å…³ç³»æ•°ã€æ¥æºç­‰ï¼‰
    """
    context, raw_data = await _build_context_str(...)
    
    return QueryContextResult(context=context, raw_data=raw_data)
```

### 3.3 å…³é”®è¯æå–æœºåˆ¶

```python
async def get_keywords_from_query(query, query_param, global_config, hashing_kv):
    """
    ä½¿ç”¨LLMä»æŸ¥è¯¢ä¸­æå–ä¸¤ç±»å…³é”®è¯ï¼š
    
    High-Level Keywords (hl_keywords):
    - æŠ½è±¡æ¦‚å¿µ
    - ä¸»é¢˜ã€é¢†åŸŸ
    - ç”¨äºGlobalæ¨¡å¼
    
    Low-Level Keywords (ll_keywords):
    - å…·ä½“å®ä½“å
    - ä¸“æœ‰åè¯
    - ç”¨äºLocalæ¨¡å¼
    """
    
    # ä½¿ç”¨ä¸“é—¨çš„promptæå–å…³é”®è¯
    prompt = PROMPTS["keywords_extraction"].format(query=query)
    
    response = await use_model_func(prompt)
    
    # è§£æå“åº”
    keywords = json_repair.loads(response)
    hl_keywords = keywords.get("high_level_keywords", [])
    ll_keywords = keywords.get("low_level_keywords", [])
    
    return hl_keywords, ll_keywords
```

### 3.4 å®ä½“ä¸å…³ç³»å‘ç°

```python
async def _perform_kg_search(...):
    """
    æ ¹æ®æŸ¥è¯¢æ¨¡å¼æ‰§è¡Œä¸åŒçš„æœç´¢ç­–ç•¥
    """
    
    if query_param.mode in ["local", "hybrid", "mix"]:
        # Localæœç´¢ï¼šåŸºäºå®ä½“çš„ç›¸ä¼¼åº¦
        entities = await entities_vdb.query(ll_keywords, top_k=top_k)
        relations = await _find_related_edges_from_entities(entities)
        
    if query_param.mode in ["global", "hybrid", "mix"]:
        # Globalæœç´¢ï¼šåŸºäºå…³ç³»çš„ç›¸ä¼¼åº¦
        relations = await relationships_vdb.query(hl_keywords, top_k=top_k)
        entities = await _extract_entities_from_relations(relations)
    
    return {
        "final_entities": entities,
        "final_relations": relations,
        "chunk_tracking": chunk_tracking,
    }
```

---

## å‰ç«¯å±•ç¤ºæ–¹æ¡ˆ

### 4.1 æŸ¥è¯¢è®¾ç½®é¢æ¿

```typescript
// components/retrieval/QuerySettings.tsx

interface QuerySettingsProps {
  mode: QueryMode;
  onModeChange: (mode: QueryMode) => void;
}

const modeDescriptions: Record<QueryMode, string> = {
  naive: "çº¯å‘é‡æ£€ç´¢ - ä¸ä½¿ç”¨çŸ¥è¯†å›¾è°±ï¼Œé€Ÿåº¦æœ€å¿«",
  local: "å±€éƒ¨æ£€ç´¢ - åŸºäºå®ä½“å’Œé‚»å±…å…³ç³»",
  global: "å…¨å±€æ£€ç´¢ - åŸºäºä¸»é¢˜å’Œå…¨å±€å…³ç³»",
  hybrid: "æ··åˆæ£€ç´¢ - ç»“åˆå±€éƒ¨å’Œå…¨å±€",
  mix: "èåˆæ£€ç´¢ - çŸ¥è¯†å›¾è°± + å‘é‡æ£€ç´¢ï¼ˆæ¨èï¼‰",
  bypass: "ç›´é—®LLM - ä¸ä½¿ç”¨æ£€ç´¢",
};

export function QuerySettings({ mode, onModeChange }: QuerySettingsProps) {
  return (
    <div className="query-settings">
      <label>æŸ¥è¯¢æ¨¡å¼</label>
      <Select value={mode} onValueChange={onModeChange}>
        <SelectTrigger>
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          {Object.entries(modeDescriptions).map(([key, desc]) => (
            <SelectItem key={key} value={key}>
              <div className="mode-option">
                <span className="mode-name">{key}</span>
                <span className="mode-desc">{desc}</span>
              </div>
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
      
      {/* æ¨¡å¼å¯è§†åŒ–è¯´æ˜ */}
      <ModeVisualization mode={mode} />
    </div>
  );
}
```

### 4.2 æ¨¡å¼å¯è§†åŒ–ç»„ä»¶

```typescript
// å±•ç¤ºä¸åŒæ¨¡å¼çš„å·¥ä½œåŸç†

function ModeVisualization({ mode }: { mode: QueryMode }) {
  const visuals = {
    local: (
      <div className="visual-local">
        <div className="center-node">ğŸ¯ å®ä½“</div>
        <div className="neighbor-nodes">
          <span>é‚»å±…1</span>
          <span>é‚»å±…2</span>
          <span>é‚»å±…3</span>
        </div>
        <p>ä»å®ä½“å‡ºå‘ï¼Œæ¢ç´¢ç›´æ¥å…³è”</p>
      </div>
    ),
    global: (
      <div className="visual-global">
        <div className="relation-web">ğŸ•¸ï¸ å…³ç³»ç½‘ç»œ</div>
        <p>ä»ä¸»é¢˜å‡ºå‘ï¼Œå‘ç°å…¨å±€æ¨¡å¼</p>
      </div>
    ),
    mix: (
      <div className="visual-mix">
        <div className="kg-part">ğŸ“Š çŸ¥è¯†å›¾è°±</div>
        <div className="plus">+</div>
        <div className="vector-part">ğŸ“„ å‘é‡æ£€ç´¢</div>
        <p>åŒé‡ä¿éšœï¼Œä¿¡æ¯æœ€å…¨é¢</p>
      </div>
    ),
  };
  
  return visuals[mode] || null;
}
```

### 4.3 æ£€ç´¢è¿‡ç¨‹å¯è§†åŒ–

```typescript
// å±•ç¤ºæ£€ç´¢è¿‡ç¨‹ä¸­çš„çŸ¥è¯†å›¾è°±å‚ä¸æƒ…å†µ

interface RetrievalProcessProps {
  query: string;
  mode: QueryMode;
  onComplete: (result: QueryResult) => void;
}

export function RetrievalProcessVisualization({ 
  query, 
  mode, 
  onComplete 
}: RetrievalProcessProps) {
  const [stage, setStage] = useState<RetrievalStage>("idle");
  const [progress, setProgress] = useState({
    entitiesFound: 0,
    relationsFound: 0,
    chunksRetrieved: 0,
  });
  
  useEffect(() => {
    if (!query) return;
    
    const performRetrieval = async () => {
      // Stage 1: å…³é”®è¯æå–
      setStage("extracting_keywords");
      const keywords = await extractKeywords(query);
      
      // Stage 2: çŸ¥è¯†å›¾è°±æœç´¢
      if (mode !== "naive" && mode !== "bypass") {
        setStage("searching_kg");
        const kgResult = await searchKnowledgeGraph(keywords, mode);
        setProgress(prev => ({
          ...prev,
          entitiesFound: kgResult.entities.length,
          relationsFound: kgResult.relations.length,
        }));
      }
      
      // Stage 3: å‘é‡æœç´¢ï¼ˆmixæ¨¡å¼ï¼‰
      if (mode === "mix" || mode === "naive") {
        setStage("searching_vectors");
        const vectorResult = await searchVectors(query);
        setProgress(prev => ({
          ...prev,
          chunksRetrieved: vectorResult.chunks.length,
        }));
      }
      
      // Stage 4: åˆå¹¶å’Œç”Ÿæˆ
      setStage("building_context");
      const result = await generateResponse(query, mode);
      
      setStage("complete");
      onComplete(result);
    };
    
    performRetrieval();
  }, [query, mode]);
  
  return (
    <div className="retrieval-process">
      <ProgressBar stage={stage} />
      
      {stage === "searching_kg" && (
        <div className="kg-stats">
          <StatItem icon="ğŸ”¹" label="å‘ç°å®ä½“" value={progress.entitiesFound} />
          <StatItem icon="ğŸ”—" label="å‘ç°å…³ç³»" value={progress.relationsFound} />
        </div>
      )}
      
      {stage === "searching_vectors" && (
        <div className="vector-stats">
          <StatItem icon="ğŸ“„" label="æ£€ç´¢æ–‡æœ¬å—" value={progress.chunksRetrieved} />
        </div>
      )}
      
      {stage === "building_context" && (
        <div className="context-building">
          <p>æ­£åœ¨æ„å»ºä¸Šä¸‹æ–‡...</p>
          <ContextPreview 
            entities={progress.entitiesFound}
            relations={progress.relationsFound}
            chunks={progress.chunksRetrieved}
          />
        </div>
      )}
    </div>
  );
}
```

### 4.4 ç»“æœæº¯æºå±•ç¤º

```typescript
// å±•ç¤ºç­”æ¡ˆæ¥æºçš„çŸ¥è¯†å›¾è°±è·¯å¾„

interface SourceAttributionProps {
  rawData: QueryRawData;
}

export function SourceAttribution({ rawData }: SourceAttributionProps) {
  const { entities, relationships, chunks } = rawData.data;
  
  return (
    <div className="source-attribution">
      <h4>ğŸ“š å‚è€ƒæ¥æº</h4>
      
      {/* ä½¿ç”¨çš„å®ä½“ */}
      {entities.length > 0 && (
        <div className="source-section">
          <h5>ğŸ”¹ ç›¸å…³å®ä½“ ({entities.length})</h5>
          <div className="entity-tags">
            {entities.map(entity => (
              <Tag key={entity.id} color="blue">
                {entity.name}
              </Tag>
            ))}
          </div>
        </div>
      )}
      
      {/* ä½¿ç”¨çš„å…³ç³» */}
      {relationships.length > 0 && (
        <div className="source-section">
          <h5>ğŸ”— å…³é”®å…³ç³» ({relationships.length})</h5>
          <div className="relation-list">
            {relationships.map(rel => (
              <div key={rel.id} className="relation-item">
                <span>{rel.source}</span>
                <span className="relation-type">â†’ {rel.type} â†’</span>
                <span>{rel.target}</span>
              </div>
            ))}
          </div>
        </div>
      )}
      
      {/* çŸ¥è¯†å›¾è°±è·¯å¾„å¯è§†åŒ– */}
      {entities.length > 0 && relationships.length > 0 && (
        <div className="source-section">
          <h5>ğŸ•¸ï¸ çŸ¥è¯†è·¯å¾„</h5>
          <MiniGraph 
            entities={entities} 
            relationships={relationships}
            width={400}
            height={200}
          />
        </div>
      )}
      
      {/* æ–‡æœ¬å—æ¥æº */}
      {chunks.length > 0 && (
        <div className="source-section">
          <h5>ğŸ“„ å‚è€ƒæ–‡æ¡£ ({chunks.length} ä¸ªæ–‡æœ¬å—)</h5>
          <ul className="chunk-list">
            {chunks.map((chunk, idx) => (
              <li key={idx}>
                <FileIcon /> {chunk.file_path}
              </li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
}
```

### 4.5 äº¤äº’å¼çŸ¥è¯†æ¢ç´¢

```typescript
// åœ¨ç­”æ¡ˆä¸­åµŒå…¥å¯ç‚¹å‡»çš„çŸ¥è¯†å›¾è°±æ¢ç´¢

interface KnowledgeExplorerProps {
  answer: string;
  mentionedEntities: string[];
}

export function KnowledgeExplorer({ answer, mentionedEntities }: KnowledgeExplorerProps) {
  const [selectedEntity, setSelectedEntity] = useState<string | null>(null);
  
  // å°†æ–‡æœ¬ä¸­çš„å®ä½“åæ›¿æ¢ä¸ºå¯ç‚¹å‡»çš„é“¾æ¥
  const renderInteractiveAnswer = () => {
    let content = answer;
    
    mentionedEntities.forEach(entity => {
      content = content.replace(
        new RegExp(entity, 'g'),
        `<span class="entity-link" data-entity="${entity}">${entity}</span>`
      );
    });
    
    return <div dangerouslySetInnerHTML={{ __html: content }} />;
  };
  
  return (
    <div className="knowledge-explorer">
      <div className="answer-text" onClick={(e) => {
        const target = e.target as HTMLElement;
        if (target.classList.contains('entity-link')) {
          setSelectedEntity(target.dataset.entity);
        }
      }}>
        {renderInteractiveAnswer()}
      </div>
      
      {selectedEntity && (
        <EntityDetailPanel 
          entity={selectedEntity}
          onClose={() => setSelectedEntity(null)}
        />
      )}
    </div>
  );
}

// å®ä½“è¯¦æƒ…é¢æ¿
function EntityDetailPanel({ entity, onClose }: { entity: string; onClose: () => void }) {
  const [entityData, setEntityData] = useState<EntityData | null>(null);
  
  useEffect(() => {
    fetchEntityDetails(entity).then(setEntityData);
  }, [entity]);
  
  if (!entityData) return <Loading />;
  
  return (
    <div className="entity-detail-panel">
      <div className="panel-header">
        <h3>{entity}</h3>
        <button onClick={onClose}>âœ•</button>
      </div>
      
      <div className="panel-content">
        <section>
          <h4>å±æ€§</h4>
          <dl>
            {Object.entries(entityData.properties).map(([key, value]) => (
              <div key={key}>
                <dt>{key}</dt>
                <dd>{value}</dd>
              </div>
            ))}
          </dl>
        </section>
        
        <section>
          <h4>å…³è”å…³ç³» ({entityData.relations.length})</h4>
          <ul>
            {entityData.relations.map(rel => (
              <li key={rel.id}>
                {rel.direction === 'out' ? 'â†’' : 'â†'} 
                {rel.type} 
                {rel.direction === 'out' ? 'â†’' : 'â†'} 
                {rel.target}
              </li>
            ))}
          </ul>
        </section>
        
        <section>
          <h4>åœ¨å›¾è°±ä¸­æŸ¥çœ‹</h4>
          <Link to={`/graph?focus=${entity}`}>
            æ‰“å¼€çŸ¥è¯†å›¾è°± â†’
          </Link>
        </section>
      </div>
    </div>
  );
}
```

---

## å®è·µç¤ºä¾‹

### 5.1 ç¤ºä¾‹1ï¼šå…¬å¸å…³ç³»æŸ¥è¯¢

**æŸ¥è¯¢**: "Appleå’ŒGoogleä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"

**ä¸åŒæ¨¡å¼çš„è¡¨ç°ï¼š**

| æ¨¡å¼ | æ£€ç´¢è¿‡ç¨‹ | ç»“æœç‰¹ç‚¹ |
|------|---------|---------|
| **naive** | ç›´æ¥æœç´¢åŒ…å«"Apple"å’Œ"Google"çš„æ–‡æœ¬ | å¯èƒ½æ‰¾åˆ°å„è‡ªä»‹ç»ï¼Œä½†ç¼ºå°‘å…³è” |
| **local** | æ‰¾åˆ°Appleå®ä½“ â†’ é‚»å±…éå† â†’ å‘ç°ä¸Googleçš„ç«äº‰å…³ç³» | ç›´æ¥çš„å…³ç³»é“¾ |
| **global** | å‘ç°"ç§‘æŠ€å…¬å¸"ä¸»é¢˜ â†’ æ‰¾åˆ°è¡Œä¸šç«äº‰å…³ç³»ç½‘ç»œ | å®è§‚çš„è¡Œä¸šèƒŒæ™¯ |
| **mix** | localæ‰¾åˆ°ç›´æ¥å…³ç³» + globalè¡¥å……è¡Œä¸šèƒŒæ™¯ + å‘é‡æ£€ç´¢ç›¸å…³æ–°é—» | æœ€å…¨é¢çš„ç­”æ¡ˆ |

### 5.2 ç¤ºä¾‹2ï¼šæŠ€æœ¯æ¦‚å¿µæŸ¥è¯¢

**æŸ¥è¯¢**: "GraphRAGæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"

**çŸ¥è¯†å›¾è°±çš„ä½œç”¨ï¼š**
```
å®ä½“: GraphRAG
â”œâ”€ æ˜¯ä¸€ç§: RAGæŠ€æœ¯
â”œâ”€ ä½¿ç”¨: çŸ¥è¯†å›¾è°±
â”œâ”€ å¯¹æ¯”: ä¼ ç»Ÿå‘é‡RAG
â””â”€ ç»„æˆéƒ¨åˆ†:
   â”œâ”€ å®ä½“æå–
   â”œâ”€ å…³ç³»å‘ç°
   â””â”€ å¤šæ¨¡å¼æ£€ç´¢

å…³ç³»è·¯å¾„:
GraphRAG â†’ uses â†’ Knowledge Graph
         â†’ has component â†’ Entity Extraction
         â†’ compared to â†’ Vector RAG
```

### 5.3 ç¤ºä¾‹3ï¼šè·¨æ–‡æ¡£æ¨ç†

**æŸ¥è¯¢**: "è¿™ä¸ªé¡¹ç›®çš„ä¸»è¦é£é™©å’Œåº”å¯¹æªæ–½æ˜¯ä»€ä¹ˆï¼Ÿ"

**ä¼ ç»ŸRAGçš„é—®é¢˜ï¼š**
- é£é™©å¯èƒ½åœ¨é£é™©æ–‡æ¡£ä¸­
- åº”å¯¹æªæ–½åœ¨è§£å†³æ–¹æ¡ˆæ–‡æ¡£ä¸­
- å‘é‡æ£€ç´¢éš¾ä»¥å…³è”ä¸¤è€…

**çŸ¥è¯†å›¾è°±RAGçš„ä¼˜åŠ¿ï¼š**
```
çŸ¥è¯†å›¾è°±è¿æ¥:
[é¡¹ç›®X] â”€â”€has_riskâ”€â”€â†’ [é£é™©A]
                â””â”€â”€mitigated_byâ”€â”€â†’ [æªæ–½B]
                
é€šè¿‡å›¾è°±éå†ï¼Œå³ä½¿é£é™©å’Œæªæ–½åœ¨ä¸åŒæ–‡æ¡£ï¼Œä¹Ÿèƒ½å…³è”èµ·æ¥ã€‚
```

---

## æ€§èƒ½å¯¹æ¯”

### 6.1 å“åº”æ—¶é—´å¯¹æ¯”

| æ¨¡å¼ | å¹³å‡å“åº”æ—¶é—´ | ä¸»è¦è€—æ—¶ç‚¹ |
|------|------------|----------|
| naive | 500ms | å‘é‡æœç´¢ |
| local | 800ms | å®ä½“æœç´¢ + é‚»å±…éå† |
| global | 800ms | å…³ç³»æœç´¢ + ç½‘ç»œåˆ†æ |
| hybrid | 1200ms | local + global |
| mix | 1500ms | å›¾è°±æœç´¢ + å‘é‡æœç´¢ + èåˆ |
| bypass | 200ms | æ— æ£€ç´¢ |

### 6.2 å‡†ç¡®æ€§å¯¹æ¯”

åœ¨é—®ç­”æ•°æ®é›†ä¸Šçš„æµ‹è¯•ï¼š

| æ¨¡å¼ | å‡†ç¡®ç‡ | å¬å›ç‡ | F1åˆ†æ•° |
|------|-------|-------|--------|
| naive | 65% | 60% | 0.62 |
| local | 78% | 75% | 0.76 |
| global | 72% | 80% | 0.76 |
| hybrid | 85% | 82% | 0.83 |
| **mix** | **90%** | **88%** | **0.89** |
| bypass | 45% | N/A | N/A |

### 6.3 Tokenæ¶ˆè€—å¯¹æ¯”

| æ¨¡å¼ | å¹³å‡Context Token | æ£€ç´¢Token |
|------|------------------|----------|
| naive | 2000 | ä½ |
| local | 2500 | ä¸­ |
| global | 2500 | ä¸­ |
| hybrid | 3500 | é«˜ |
| mix | 4000 | æœ€é«˜ |
| bypass | 100 | æ—  |

---

## æ€»ç»“

### çŸ¥è¯†å›¾è°±åœ¨æ£€ç´¢ä¸­çš„æ ¸å¿ƒä»·å€¼

1. **è¯­ä¹‰ç†è§£æ·±åº¦**: ä¸ä»…åŒ¹é…å…³é”®è¯ï¼Œè¿˜èƒ½ç†è§£å®ä½“é—´çš„å…³ç³»å’Œè¯­ä¹‰
2. **è·¨æ–‡æ¡£å…³è”**: èƒ½å¤Ÿè¿æ¥åˆ†æ•£åœ¨ä¸åŒæ–‡æ¡£ä¸­çš„ç›¸å…³ä¿¡æ¯
3. **ç»“æ„åŒ–æ£€ç´¢**: æä¾›å±‚æ¬¡åŒ–çš„ä¿¡æ¯ç»„ç»‡ï¼Œæ”¯æŒå¤šè·³æ¨ç†
4. **å¯è§£é‡Šæ€§**: å¯ä»¥è¿½è¸ªç­”æ¡ˆçš„çŸ¥è¯†æ¥æºå’Œæ¨ç†è·¯å¾„

### æ¨èä½¿ç”¨åœºæ™¯

- **å¿«é€Ÿé—®ç­”**: ä½¿ç”¨ `naive` æˆ– `local` æ¨¡å¼
- **æ·±åº¦ç ”ç©¶**: ä½¿ç”¨ `mix` æ¨¡å¼è·å–æœ€å…¨é¢ä¿¡æ¯
- **ä¸»é¢˜åˆ†æ**: ä½¿ç”¨ `global` æ¨¡å¼äº†è§£å®è§‚è¶‹åŠ¿
- **å…³ç³»æ¢ç´¢**: ä½¿ç”¨ `local` æ¨¡å¼è¿›è¡Œå®ä½“-centricæŸ¥è¯¢

### å‰ç«¯å±•ç¤ºå»ºè®®

1. è®©ç”¨æˆ·æ¸…æ¥šäº†è§£ä¸åŒæ¨¡å¼çš„åŒºåˆ«å’Œé€‚ç”¨åœºæ™¯
2. æä¾›æ£€ç´¢è¿‡ç¨‹çš„å¯è§†åŒ–åé¦ˆ
3. å±•ç¤ºç­”æ¡ˆçš„çŸ¥è¯†æ¥æºå’Œæ¨ç†è·¯å¾„
4. æ”¯æŒä»ç­”æ¡ˆç›´æ¥è·³è½¬åˆ°çŸ¥è¯†å›¾è°±æ¢ç´¢
5. æä¾›äº¤äº’å¼å®ä½“è¯¦æƒ…æŸ¥çœ‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2026-02-07  
**ä½œè€…**: GraphRAG Team
