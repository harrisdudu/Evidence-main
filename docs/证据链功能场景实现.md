# Evidence 证据链核心功能与场景实现

## 一、核心数据结构

### 1.1 证据等级 (EvidenceLevel)

| 等级 | 说明 | 示例 |
|------|------|------|
| **S** | 监管机构/权威发布 | 央行文件、证监会法规、国家法律法规 |
| **A** | 头部研报/顶刊论文 | 券商研报、Wind数据、顶刊论文 |
| **B** | 中型机构报告 | 中型机构分析报告、深度分析 |
| **C** | 普通报告/书籍 | 行业周报、书籍章节、普通报告 |

```python
class EvidenceLevel(str, Enum):
    """证据等级枚举"""
    S = "S"  # 监管机构/权威发布 - 最高可信度
    A = "A"  # 头部研报/顶刊论文
    B = "B"  # 中型机构报告
    C = "C"  # 普通报告/书籍章节
```

### 1.2 证据链关系类型 (EvidenceRelationType)

| 类型 | 说明 | 示例 |
|------|------|------|
| **CAUSAL** | 因果关系 | 政策变化 → 市场影响 |
| **SUPPORT** | 支持关系 | 数据 → 投资观点 |
| **CONTRADICT** | 反驳关系 | 不同观点碰撞 |
| **RELATED** | 一般相关 | 行业 → 关联公司 |

```python
class EvidenceRelationType(str, Enum):
    """证据链关系类型"""
    CAUSAL = "causal"        # 因果关系: A导致B
    SUPPORT = "support"       # 支持关系: A支持B
    CONTRADICT = "contradict" # 反驳关系: A反驳B
    RELATED = "related"      # 一般相关
```

### 1.3 精准溯源 (SourceProvenance)

```python
class SourceProvenance(TypedDict):
    """精准溯源 - 文档级来源信息"""
    doc_id: str                    # 文档唯一ID
    file_name: str                 # 文件名
    file_path: str                 # 文件完整路径
    page_num: Optional[int]        # 页码 (可选)
    paragraph_id: Optional[str]     # 段落ID (可选)
    chunk_id: str                  # 对应的chunk ID
```

**溯源数据结构示例**：
```json
{
    "doc_id": "md5hash...",
    "file_name": "政策文件.pdf",
    "file_path": "/path/to/document.pdf",
    "page_num": 5,
    "paragraph_id": "p123",
    "chunk_id": "chunk_xxx"
}
```

---

## 二、证据链提取提示词

### 2.1 LLM 输出格式（7字段）

```
relation<|>源实体<|>目标实体<|>关系类型<|>证据等级<|>关键词<|>描述
```

### 2.2 提示词模板

```python
PROMPTS["entity_extraction_with_evidence"] = """---Role---
You are a Knowledge Graph Specialist with expertise in Evidence-based reasoning.

---Instructions---
1. **Entity Extraction**: Extract entity_name, entity_type, entity_description

2. **Evidence Chain Classification**:
   - `causal`: A causes/leads to B (政策变化 → 市场影响)
   - `support`: A supports/verifies B (数据 → 投资观点)
   - `contradict`: A contradicts/refutes B
   - `related`: A is generally related to B

3. **Evidence Level Assignment**:
   - `S`: 监管机构官方文件、政府发文、法律法规
   - `A`: 头部券商研报、顶刊论文、权威数据库(Wind/Bloomberg)
   - `B`: 中型机构报告、深度分析、行业协会指南
   - `C`: 普通报告、书籍章节、行业周报/月报

4. **Output Format (7 fields)**:
   relation<|>source<|>target<|>relation_type<|>evidence_level<|>keywords<|>description
"""
```

### 2.3 输出示例

```
entity<|>央行<|>organization<|>央行是中国最高的货币金融管理机构
entity<|>银发〔2025〕18号<|>regulation<|>央行发布的关于完善结构性货币政策工具的通知文件

relation<|>银发〔2025〕18号<|>科技创新领域<|>causal<|>S<|>政策扩大适用<|>该通知将结构性货币政策工具适用范围扩大至科技创新领域
relation<|>Wind<|>科创板<|>support<|>A<|>数据来源,融资规模<|>Wind数据显示科创板企业融资规模数据
```

---

## 三、场景标签体系

### 3.1 8大场景分类

| 场景大类 | 细分标签 |
|---------|---------|
| 投研分析 | 权益投研、固收投研、量化分析、行业研究、个股研究、债券研究 |
| 风险控制 | 信贷风控、市场风控、操作风控、信用风险、流动性风险、合规风险 |
| 合规审核 | 反洗钱、监管合规、内控合规、KYC、AML、合规审查 |
| 产品设计 | 理财产品、基金产品、保险产品、结构化产品、衍生品设计 |
| 市场研判 | 宏观经济、行业趋势、市场情绪、资金流向、政策解读 |
| 政策法规 | 监管政策、法律法规、行业规范、指导意见、管理办法 |
| 学术研究 | 实证研究、理论研究、案例研究、文献综述、方法论 |
| 案例分析 | 处罚案例、典型案例、风险事件、处置案例、合规案例 |

### 3.2 场景枚举定义

```python
class SceneCategory(str, Enum):
    """场景大类枚举"""
    INVESTMENT_RESEARCH = "投研分析"
    RISK_CONTROL = "风险控制"
    COMPLIANCE = "合规审核"
    PRODUCT_DESIGN = "产品设计"
    MARKET_RESEARCH = "市场研判"
    POLICY_REGULATION = "政策法规"
    ACADEMIC_RESEARCH = "学术研究"
    CASE_ANALYSIS = "案例分析"
```

---

## 四、自定义切分策略

### 4.1 场景对应切分方式

| 场景类型 | 切分方式 | 示例 |
|---------|---------|------|
| 政策法规 | 按条款/子目切分 | 第1条、第2章、第一款 |
| 投研报告 | 按观点+论据切分 | 分析师观点 + 数据支撑 |
| 学术论文 | 按研究结论/方法切分 | 研究结论、数据结论、研究方法 |
| 案例分析 | 按事实/违规/处罚切分 | 违规点、处罚结果、监管依据 |
| 市场数据 | 按数据指标切分 | 数值 + 结论 |

### 4.2 EvidenceChunk 数据结构

```python
@dataclass
class EvidenceChunk:
    content: str                      # 证据内容
    chunk_index: int                  # 块索引
    scene_category: SceneCategory     # 场景大类
    scene_tags: List[str]             # 场景标签
    provenance: Optional[Dict]        # 溯源信息
    evidence_level: str = "B"         # 证据等级
    metadata: Dict[str, Any]           # 额外元数据
```

### 4.3 EvidenceSplitter 使用示例

```python
from lightrag.evidence_splitter import EvidenceSplitter

# 方式1: 指定场景类型
splitter = EvidenceSplitter(scene_type="政策法规")
chunks = splitter.split(text, metadata)

# 方式2: 自动检测场景
splitter = EvidenceSplitter()
chunks = splitter.split(text, {"file_path": "/path/to/研报.pdf"})
```

---

## 五、核心 API

### 5.1 溯源工具函数

```python
from lightrag.utils import (
    create_source_provenance,
    parse_provenance_from_chunk,
    merge_provenances,
)

# 创建溯源信息
provenance = create_source_provenance(
    file_path="/docs/政策文件.pdf",
    chunk_id="chunk_001",
    page_num=5,
    paragraph_id="p123"
)

# 合并多个溯源（去重）
merged = merge_provenances(existing_provenances, new_provenances)
```

### 5.2 场景化切分函数

```python
from lightrag.operate import (
    chunking_by_evidence_splitter,
    chunking_with_scene_detection,
)

# 使用 EvidenceSplitter 进行场景化切分
chunks = chunking_by_evidence_splitter(
    content=text,
    file_path="/path/to/document.pdf",
    scene_type="政策法规"
)
```

### 5.3 证据链查询 API (Neo4j)

```python
# 按证据等级查询实体
await kg.get_entities_by_evidence_level("S", limit=100)

# 按证据等级查询关系
await kg.get_relations_by_evidence_level("A", limit=100)

# 按证据链类型查询关系
await kg.get_relations_by_type("causal", limit=100)

# 按场景标签查询实体
await kg.get_entities_by_scene("投研分析")

# 按场景标签查询关系
await kg.get_relations_by_scene("风险控制")

# 按证据等级+场景组合查询
await kg.get_entities_by_evidence_level_and_scene("S", "政策法规")

# 查询实体溯源
await kg.get_entity_provenance("实体名称")

# 查询关系溯源
await kg.get_relation_provenance("源实体", "目标实体")

# 按文件路径查询实体
await kg.get_entities_by_file("/path/to/file.pdf")
```

---

## 六、数据流程

### 6.1 完整处理流程

```
原始文档
    ↓
┌─────────────────────────────────────────────┐
│  [EvidenceSplitter] 场景化切分              │
│  - 自动识别场景类型                          │
│  - 按业务逻辑切分为最小证据单元              │
│  - 标注场景标签和证据等级                    │
└─────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────┐
│  EvidenceChunk                              │
│  - content: 证据内容                        │
│  - scene_category: 政策法规                 │
│  - scene_tags: [监管政策, 条款]             │
│  - evidence_level: S                        │
│  - provenance: {doc_id, page_num...}       │
└─────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────┐
│  [LLM 提取] entity_extraction_with_evidence │
│  - 实体提取                                 │
│  - 关系提取 + 证据链类型分类                 │
│  - 证据等级标注                             │
└─────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────┐
│  实体/关系 + 证据链属性                      │
│  - relation_type: causal                    │
│  - evidence_level: S                        │
│  - source_provenance: [...]                │
│  - scene_tags: [...]                        │
└─────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────┐
│  [Neo4j 存储] 证据链入库                    │
│  - 节点属性: evidence_level, scene_tags     │
│  - 边属性: relation_type, evidence_level    │
│  - 溯源信息: source_provenance              │
└─────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────┐
│  [查询检索] 证据链支持                      │
│  - 按证据等级排序/筛选                      │
│  - 按证据链类型过滤                         │
│  - 按场景标签检索                           │
│  - 精准溯源到原始文档                        │
└─────────────────────────────────────────────┘
```

### 6.2 关键代码映射

| 功能 | 实现位置 |
|------|---------|
| 证据等级定义 | `types.py` - `EvidenceLevel` |
| 证据链类型 | `types.py` - `EvidenceRelationType` |
| 溯源结构 | `types.py` - `SourceProvenance` |
| 提取提示词 | `prompt.py` - `entity_extraction_with_evidence` |
| 场景切分 | `evidence_splitter.py` - `EvidenceSplitter` |
| 溯源工具 | `utils.py` - `create_source_provenance` |
| 解析函数 | `operate.py` - `_handle_single_relationship_extraction_with_evidence` |
| 查询API | `kg/neo4j_impl.py` - `get_entities_by_evidence_level` 等 |

---

## 七、代码文件清单

| 文件 | 核心功能 |
|------|---------|
| `lightrag/types.py` | EvidenceLevel, SourceProvenance, EvidenceRelationType 定义 |
| `lightrag/prompt.py` | entity_extraction_with_evidence 提示词模板 |
| `lightrag/evidence_splitter.py` | 场景标签体系 + EvidenceSplitter 切分器 |
| `lightrag/utils.py` | create_source_provenance 溯源工具函数 |
| `lightrag/operate.py` | 证据链解析函数、场景化 chunking 集成 |
| `lightrag/kg/neo4j_impl.py` | 证据链查询 API |

---

## 八、使用示例

### 8.1 完整使用流程

```python
from lightrag import LightRAG
from lightrag.evidence_splitter import EvidenceSplitter
from lightrag.utils import create_source_provenance

# 1. 初始化 LightRAG
rag = LightRAG(working_dir="./rag_storage")

# 2. 使用场景化切分
splitter = EvidenceSplitter(scene_type="投研报告")
chunks = splitter.split(
    text="""2025年1月，央行发布《关于进一步完善结构性货币政策工具的通知》。
    业内人士指出，此举将显著降低科创企业融资成本。
    根据Wind数据显示，2024年四季度科创板企业整体融资规模已达1.2万亿元。
    """,
    metadata={"file_path": "/docs/央行通知.pdf"}
)

# 3. 每个 chunk 都包含场景信息
for chunk in chunks:
    print(f"场景: {chunk.scene_category}")
    print(f"标签: {chunk.scene_tags}")
    print(f"证据等级: {chunk.evidence_level}")
    print(f"内容: {chunk.content[:50]}...")

# 4. 添加文档（使用增强的提取提示词）
await rag.aadd(
    "/docs/央行通知.pdf",
    chunking_strategy="evidence"  # 使用场景化切分
)

# 5. 按证据等级查询（优先S级）
results = await rag.aquey(
    "货币政策对科创企业的影响",
    param={"evidence_level": "S"}  # 优先返回S级证据
)
```

### 8.2 溯源查询示例

```python
# 查询特定实体的溯源信息
provenance = await kg.get_entity_provenance("央行")

# 返回示例:
# [
#     {
#         "doc_id": "abc123...",
#         "file_name": "央行通知.pdf",
#         "file_path": "/docs/央行通知.pdf",
#         "page_num": 1,
#         "paragraph_id": "p5",
#         "chunk_id": "chunk_001"
#     }
# ]
```

---

*文档版本: v1.0*  
*创建时间: 2026-02-27*  
*项目: LightRAG Evidence 证据链二次开发*

---

## 九、证据推理功能

### 9.1 功能说明

| 功能 | 说明 |
|------|------|
| 因果链追溯 | 从某实体出发，追溯完整的 causal 类型因果链路径 |
| 证据聚合 | 聚合相同主题/类型/场景的证据，计算综合权重 |
| 交叉验证 | 检测 support/contradict 关系，验证证据一致性 |

### 9.2 API 使用

```python
# 1. 因果链追溯
results = await kg.get_causal_chain(
    entity_id="降准政策",
    max_depth=5,
    evidence_level="S",
    limit=20
)

# 2. 证据聚合
results = await kg.aggregate_evidence(
    topic="科创板",
    scene_tag="投研分析",
    evidence_level="S",
    min_weight=3
)

# 3. 交叉验证
result = await kg.cross_validate(
    claim_entity="货币政策将利好股市",
    min_evidence_count=1
)
```

### 9.3 返回示例

**因果链追溯：**
```python
[
    {
        "start_entity": "降准政策",
        "end_entity": "银行负债成本降低",
        "chain_entities": [...],
        "chain_relations": [
            {"description": "降准释放流动性...", "evidence_level": "S"}
        ],
        "chain_length": 3,
        "chain_weight": 12
    }
]
```

**交叉验证：**
```python
{
    "claim": "货币政策将利好股市",
    "conclusion": "证据支持",
    "support_evidence": [{"entity": "降准", "level": "S", "type": "support"}],
    "contradict_evidence": [],
    "support_count": 3,
    "contradict_count": 0,
    "support_weight": 10,
    "contradict_weight": 0
}
```

### 9.4 验证结论规则

| 条件 | 结论 |
|------|------|
| support > contradict × 1.5 | 证据支持 |
| contradict > support × 1.5 | 证据反驳 |
| support > 0 且 contradict > 0 | 证据存在分歧 |
| 仅支持证据 | 证据支持(单方面) |
| 仅反驳证据 | 证据反驳(单方面) |
| 都为0 | 证据不足 |

### 9.5 证据等级权重

| 等级 | 权重 |
|------|------|
| S | 4 |
| A | 3 |
| B | 2 |
| C | 1 |

---

*文档版本: v1.1*  
*更新时间: 2026-02-27*  
*项目: LightRAG Evidence 证据链二次开发*